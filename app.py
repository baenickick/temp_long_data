# app.py
import streamlit as st
import pandas as pd
import numpy as np
from io import BytesIO
from datetime import datetime
import io

st.set_page_config(page_title="ìƒí™œì¸êµ¬ CSV ë³‘í•© (ì§€ì—­ ì„ íƒ)", layout="wide")
st.title("ìƒí™œì¸êµ¬ CSV ë³‘í•© ì›¹ì•± (ì„œìš¸ ì „ì²´ ì§€ì—­ ì„ íƒ)")

# ì „ì²´ ì„œìš¸ ì§€ì—­ ë§¤ì¹­ ë°ì´í„°
region_data = """í†µê³„ì²­í–‰ì •ë™ì½”ë“œ	ì‹œë„ëª…	ì‹œêµ°êµ¬ëª…	í–‰ì •ë™ëª…
1101053	ì„œìš¸	ì¢…ë¡œêµ¬	ì‚¬ì§ë™
1101054	ì„œìš¸	ì¢…ë¡œêµ¬	ì‚¼ì²­ë™
1101055	ì„œìš¸	ì¢…ë¡œêµ¬	ë¶€ì•”ë™
1101056	ì„œìš¸	ì¢…ë¡œêµ¬	í‰ì°½ë™
1101057	ì„œìš¸	ì¢…ë¡œêµ¬	ë¬´ì•…ë™
1101058	ì„œìš¸	ì¢…ë¡œêµ¬	êµë‚¨ë™
1101060	ì„œìš¸	ì¢…ë¡œêµ¬	ê°€íšŒë™
1101061	ì„œìš¸	ì¢…ë¡œêµ¬	ì¢…ë¡œ1.2.3.4ê°€ë™
1101063	ì„œìš¸	ì¢…ë¡œêµ¬	ì¢…ë¡œ5.6ê°€ë™
1101064	ì„œìš¸	ì¢…ë¡œêµ¬	ì´í™”ë™
1101067	ì„œìš¸	ì¢…ë¡œêµ¬	ì°½ì‹ 1ë™
1101068	ì„œìš¸	ì¢…ë¡œêµ¬	ì°½ì‹ 2ë™
1101069	ì„œìš¸	ì¢…ë¡œêµ¬	ì°½ì‹ 3ë™
1101070	ì„œìš¸	ì¢…ë¡œêµ¬	ìˆ­ì¸1ë™
1101071	ì„œìš¸	ì¢…ë¡œêµ¬	ìˆ­ì¸2ë™
1101072	ì„œìš¸	ì¢…ë¡œêµ¬	ì²­ìš´íš¨ìë™
1101073	ì„œìš¸	ì¢…ë¡œêµ¬	í˜œí™”ë™
1102052	ì„œìš¸	ì¤‘êµ¬	ì†Œê³µë™
1102054	ì„œìš¸	ì¤‘êµ¬	íšŒí˜„ë™
1102055	ì„œìš¸	ì¤‘êµ¬	ëª…ë™
1102057	ì„œìš¸	ì¤‘êµ¬	í•„ë™
1102058	ì„œìš¸	ì¤‘êµ¬	ì¥ì¶©ë™
1102059	ì„œìš¸	ì¤‘êµ¬	ê´‘í¬ë™
1102060	ì„œìš¸	ì¤‘êµ¬	ì„ì§€ë¡œë™
1102065	ì„œìš¸	ì¤‘êµ¬	ì‹ ë‹¹5ë™
1102067	ì„œìš¸	ì¤‘êµ¬	í™©í•™ë™
1102068	ì„œìš¸	ì¤‘êµ¬	ì¤‘ë¦¼ë™
1102069	ì„œìš¸	ì¤‘êµ¬	ì‹ ë‹¹ë™
1102070	ì„œìš¸	ì¤‘êµ¬	ë‹¤ì‚°ë™
1102071	ì„œìš¸	ì¤‘êµ¬	ì•½ìˆ˜ë™
1102072	ì„œìš¸	ì¤‘êµ¬	ì²­êµ¬ë™
1102073	ì„œìš¸	ì¤‘êµ¬	ë™í™”ë™
1103051	ì„œìš¸	ìš©ì‚°êµ¬	í›„ì•”ë™
1103052	ì„œìš¸	ìš©ì‚°êµ¬	ìš©ì‚°2ê°€ë™
1103053	ì„œìš¸	ìš©ì‚°êµ¬	ë‚¨ì˜ë™
1103057	ì„œìš¸	ìš©ì‚°êµ¬	ì›íš¨ë¡œ2ë™
1103058	ì„œìš¸	ìš©ì‚°êµ¬	íš¨ì°½ë™
1103059	ì„œìš¸	ìš©ì‚°êµ¬	ìš©ë¬¸ë™
1103063	ì„œìš¸	ìš©ì‚°êµ¬	ì´ì´Œ1ë™
1103064	ì„œìš¸	ìš©ì‚°êµ¬	ì´ì´Œ2ë™
1103065	ì„œìš¸	ìš©ì‚°êµ¬	ì´íƒœì›1ë™
1103066	ì„œìš¸	ìš©ì‚°êµ¬	ì´íƒœì›2ë™
1103069	ì„œìš¸	ìš©ì‚°êµ¬	ì„œë¹™ê³ ë™
1103070	ì„œìš¸	ìš©ì‚°êµ¬	ë³´ê´‘ë™
1103071	ì„œìš¸	ìš©ì‚°êµ¬	ì²­íŒŒë™
1103072	ì„œìš¸	ìš©ì‚°êµ¬	ì›íš¨ë¡œ1ë™
1103073	ì„œìš¸	ìš©ì‚°êµ¬	í•œê°•ë¡œë™
1103074	ì„œìš¸	ìš©ì‚°êµ¬	í•œë‚¨ë™
1104052	ì„œìš¸	ì„±ë™êµ¬	ì™•ì‹­ë¦¬2ë™
1104054	ì„œìš¸	ì„±ë™êµ¬	ë§ˆì¥ë™
1104055	ì„œìš¸	ì„±ë™êµ¬	ì‚¬ê·¼ë™
1104056	ì„œìš¸	ì„±ë™êµ¬	í–‰ë‹¹1ë™
1104057	ì„œìš¸	ì„±ë™êµ¬	í–‰ë‹¹2ë™
1104058	ì„œìš¸	ì„±ë™êµ¬	ì‘ë´‰ë™
1104059	ì„œìš¸	ì„±ë™êµ¬	ê¸ˆí˜¸1ê°€ë™
1104062	ì„œìš¸	ì„±ë™êµ¬	ê¸ˆí˜¸4ê°€ë™
1104065	ì„œìš¸	ì„±ë™êµ¬	ì„±ìˆ˜1ê°€1ë™
1104066	ì„œìš¸	ì„±ë™êµ¬	ì„±ìˆ˜1ê°€2ë™
1104067	ì„œìš¸	ì„±ë™êµ¬	ì„±ìˆ˜2ê°€1ë™
1104068	ì„œìš¸	ì„±ë™êµ¬	ì„±ìˆ˜2ê°€3ë™
1104069	ì„œìš¸	ì„±ë™êµ¬	ì†¡ì •ë™
1104070	ì„œìš¸	ì„±ë™êµ¬	ìš©ë‹µë™
1104071	ì„œìš¸	ì„±ë™êµ¬	ì™•ì‹­ë¦¬ë„ì„ ë™
1104072	ì„œìš¸	ì„±ë™êµ¬	ê¸ˆí˜¸2.3ê°€ë™
1104073	ì„œìš¸	ì„±ë™êµ¬	ì˜¥ìˆ˜ë™
1105053	ì„œìš¸	ê´‘ì§„êµ¬	í™”ì–‘ë™
1105054	ì„œìš¸	ê´‘ì§„êµ¬	êµ°ìë™
1105055	ì„œìš¸	ê´‘ì§„êµ¬	ì¤‘ê³¡1ë™
1105056	ì„œìš¸	ê´‘ì§„êµ¬	ì¤‘ê³¡2ë™
1105057	ì„œìš¸	ê´‘ì§„êµ¬	ì¤‘ê³¡3ë™
1105058	ì„œìš¸	ê´‘ì§„êµ¬	ì¤‘ê³¡4ë™
1105059	ì„œìš¸	ê´‘ì§„êµ¬	ëŠ¥ë™
1105060	ì„œìš¸	ê´‘ì§„êµ¬	êµ¬ì˜1ë™
1105061	ì„œìš¸	ê´‘ì§„êµ¬	êµ¬ì˜2ë™
1105062	ì„œìš¸	ê´‘ì§„êµ¬	êµ¬ì˜3ë™
1105063	ì„œìš¸	ê´‘ì§„êµ¬	ê´‘ì¥ë™
1105064	ì„œìš¸	ê´‘ì§„êµ¬	ìì–‘1ë™
1105065	ì„œìš¸	ê´‘ì§„êµ¬	ìì–‘2ë™
1105066	ì„œìš¸	ê´‘ì§„êµ¬	ìì–‘3ë™
1105067	ì„œìš¸	ê´‘ì§„êµ¬	ìì–‘4ë™
1106071	ì„œìš¸	ë™ëŒ€ë¬¸êµ¬	íšŒê¸°ë™
1106072	ì„œìš¸	ë™ëŒ€ë¬¸êµ¬	íœ˜ê²½1ë™
1106073	ì„œìš¸	ë™ëŒ€ë¬¸êµ¬	íœ˜ê²½2ë™
1106080	ì„œìš¸	ë™ëŒ€ë¬¸êµ¬	ì²­ëŸ‰ë¦¬ë™
1106081	ì„œìš¸	ë™ëŒ€ë¬¸êµ¬	ìš©ì‹ ë™
1106082	ì„œìš¸	ë™ëŒ€ë¬¸êµ¬	ì œê¸°ë™
1106083	ì„œìš¸	ë™ëŒ€ë¬¸êµ¬	ì „ë†1ë™
1106084	ì„œìš¸	ë™ëŒ€ë¬¸êµ¬	ì „ë†2ë™
1106086	ì„œìš¸	ë™ëŒ€ë¬¸êµ¬	ë‹µì‹­ë¦¬2ë™
1106087	ì„œìš¸	ë™ëŒ€ë¬¸êµ¬	ì¥ì•ˆ1ë™
1106088	ì„œìš¸	ë™ëŒ€ë¬¸êµ¬	ì¥ì•ˆ2ë™
1106089	ì„œìš¸	ë™ëŒ€ë¬¸êµ¬	ì´ë¬¸1ë™
1106090	ì„œìš¸	ë™ëŒ€ë¬¸êµ¬	ì´ë¬¸2ë™
1106091	ì„œìš¸	ë™ëŒ€ë¬¸êµ¬	ë‹µì‹­ë¦¬1ë™
1107052	ì„œìš¸	ì¤‘ë‘êµ¬	ë©´ëª©2ë™
1107054	ì„œìš¸	ì¤‘ë‘êµ¬	ë©´ëª©4ë™
1107055	ì„œìš¸	ì¤‘ë‘êµ¬	ë©´ëª©5ë™
1107057	ì„œìš¸	ì¤‘ë‘êµ¬	ë©´ëª©7ë™
1107059	ì„œìš¸	ì¤‘ë‘êµ¬	ìƒë´‰1ë™
1107060	ì„œìš¸	ì¤‘ë‘êµ¬	ìƒë´‰2ë™
1107061	ì„œìš¸	ì¤‘ë‘êµ¬	ì¤‘í™”1ë™
1107062	ì„œìš¸	ì¤‘ë‘êµ¬	ì¤‘í™”2ë™
1107064	ì„œìš¸	ì¤‘ë‘êµ¬	ë¬µ1ë™
1107065	ì„œìš¸	ì¤‘ë‘êµ¬	ë¬µ2ë™
1107068	ì„œìš¸	ì¤‘ë‘êµ¬	ë§ìš°3ë™
1107069	ì„œìš¸	ì¤‘ë‘êµ¬	ì‹ ë‚´1ë™
1107070	ì„œìš¸	ì¤‘ë‘êµ¬	ì‹ ë‚´2ë™
1107071	ì„œìš¸	ì¤‘ë‘êµ¬	ë©´ëª©ë³¸ë™
1107072	ì„œìš¸	ì¤‘ë‘êµ¬	ë©´ëª©3.8ë™
1107073	ì„œìš¸	ì¤‘ë‘êµ¬	ë§ìš°ë³¸ë™
1108058	ì„œìš¸	ì„±ë¶êµ¬	ëˆì•”1ë™
1108059	ì„œìš¸	ì„±ë¶êµ¬	ëˆì•”2ë™
1108060	ì„œìš¸	ì„±ë¶êµ¬	ì•ˆì•”ë™
1108061	ì„œìš¸	ì„±ë¶êµ¬	ë³´ë¬¸ë™
1108062	ì„œìš¸	ì„±ë¶êµ¬	ì •ë¦‰1ë™
1108063	ì„œìš¸	ì„±ë¶êµ¬	ì •ë¦‰2ë™
1108064	ì„œìš¸	ì„±ë¶êµ¬	ì •ë¦‰3ë™
1108065	ì„œìš¸	ì„±ë¶êµ¬	ì •ë¦‰4ë™
1108066	ì„œìš¸	ì„±ë¶êµ¬	ê¸¸ìŒ1ë™
1108068	ì„œìš¸	ì„±ë¶êµ¬	ê¸¸ìŒ2ë™
1108071	ì„œìš¸	ì„±ë¶êµ¬	ì›”ê³¡1ë™
1108072	ì„œìš¸	ì„±ë¶êµ¬	ì›”ê³¡2ë™
1108076	ì„œìš¸	ì„±ë¶êµ¬	ì¥ìœ„1ë™
1108077	ì„œìš¸	ì„±ë¶êµ¬	ì¥ìœ„2ë™
1108078	ì„œìš¸	ì„±ë¶êµ¬	ì¥ìœ„3ë™
1108081	ì„œìš¸	ì„±ë¶êµ¬	ì„±ë¶ë™
1108082	ì„œìš¸	ì„±ë¶êµ¬	ì‚¼ì„ ë™
1108083	ì„œìš¸	ì„±ë¶êµ¬	ë™ì„ ë™
1108084	ì„œìš¸	ì„±ë¶êµ¬	ì¢…ì•”ë™
1108085	ì„œìš¸	ì„±ë¶êµ¬	ì„ê´€ë™
1109060	ì„œìš¸	ê°•ë¶êµ¬	ë²ˆ1ë™
1109061	ì„œìš¸	ê°•ë¶êµ¬	ë²ˆ2ë™
1109062	ì„œìš¸	ê°•ë¶êµ¬	ë²ˆ3ë™
1109063	ì„œìš¸	ê°•ë¶êµ¬	ìˆ˜ìœ 1ë™
1109064	ì„œìš¸	ê°•ë¶êµ¬	ìˆ˜ìœ 2ë™
1109065	ì„œìš¸	ê°•ë¶êµ¬	ìˆ˜ìœ 3ë™
1109069	ì„œìš¸	ê°•ë¶êµ¬	ì‚¼ì–‘ë™
1109070	ì„œìš¸	ê°•ë¶êµ¬	ë¯¸ì•„ë™
1109071	ì„œìš¸	ê°•ë¶êµ¬	ì†¡ì¤‘ë™
1109072	ì„œìš¸	ê°•ë¶êµ¬	ì†¡ì²œë™
1109073	ì„œìš¸	ê°•ë¶êµ¬	ì‚¼ê°ì‚°ë™
1109074	ì„œìš¸	ê°•ë¶êµ¬	ìš°ì´ë™
1109075	ì„œìš¸	ê°•ë¶êµ¬	ì¸ìˆ˜ë™
1110051	ì„œìš¸	ë„ë´‰êµ¬	ìŒë¬¸1ë™
1110052	ì„œìš¸	ë„ë´‰êµ¬	ìŒë¬¸2ë™
1110053	ì„œìš¸	ë„ë´‰êµ¬	ìŒë¬¸3ë™
1110054	ì„œìš¸	ë„ë´‰êµ¬	ìŒë¬¸4ë™
1110055	ì„œìš¸	ë„ë´‰êµ¬	ë°©í•™1ë™
1110056	ì„œìš¸	ë„ë´‰êµ¬	ë°©í•™2ë™
1110057	ì„œìš¸	ë„ë´‰êµ¬	ë°©í•™3ë™
1110059	ì„œìš¸	ë„ë´‰êµ¬	ì°½1ë™
1110060	ì„œìš¸	ë„ë´‰êµ¬	ì°½2ë™
1110061	ì„œìš¸	ë„ë´‰êµ¬	ì°½3ë™
1110062	ì„œìš¸	ë„ë´‰êµ¬	ì°½4ë™
1110063	ì„œìš¸	ë„ë´‰êµ¬	ì°½5ë™
1110064	ì„œìš¸	ë„ë´‰êµ¬	ë„ë´‰1ë™
1110065	ì„œìš¸	ë„ë´‰êµ¬	ë„ë´‰2ë™
1111051	ì„œìš¸	ë…¸ì›êµ¬	ì›”ê³„1ë™
1111052	ì„œìš¸	ë…¸ì›êµ¬	ì›”ê³„2ë™
1111053	ì„œìš¸	ë…¸ì›êµ¬	ì›”ê³„3ë™
1111056	ì„œìš¸	ë…¸ì›êµ¬	ê³µë¦‰2ë™
1111058	ì„œìš¸	ë…¸ì›êµ¬	í•˜ê³„1ë™
1111059	ì„œìš¸	ë…¸ì›êµ¬	í•˜ê³„2ë™
1111060	ì„œìš¸	ë…¸ì›êµ¬	ì¤‘ê³„ë³¸ë™
1111061	ì„œìš¸	ë…¸ì›êµ¬	ì¤‘ê³„1ë™
1111064	ì„œìš¸	ë…¸ì›êµ¬	ì¤‘ê³„4ë™
1111065	ì„œìš¸	ë…¸ì›êµ¬	ìƒê³„1ë™
1111066	ì„œìš¸	ë…¸ì›êµ¬	ìƒê³„2ë™
1111069	ì„œìš¸	ë…¸ì›êµ¬	ìƒê³„5ë™
1111072	ì„œìš¸	ë…¸ì›êµ¬	ìƒê³„8ë™
1111073	ì„œìš¸	ë…¸ì›êµ¬	ìƒê³„9ë™
1111074	ì„œìš¸	ë…¸ì›êµ¬	ìƒê³„10ë™
1111076	ì„œìš¸	ë…¸ì›êµ¬	ìƒê³„3.4ë™
1111077	ì„œìš¸	ë…¸ì›êµ¬	ìƒê³„6.7ë™
1111078	ì„œìš¸	ë…¸ì›êµ¬	ì¤‘ê³„2.3ë™
1111079	ì„œìš¸	ë…¸ì›êµ¬	ê³µë¦‰1ë™
1112051	ì„œìš¸	ì€í‰êµ¬	ë…¹ë²ˆë™
1112052	ì„œìš¸	ì€í‰êµ¬	ë¶ˆê´‘1ë™
1112055	ì„œìš¸	ì€í‰êµ¬	ê°ˆí˜„1ë™
1112056	ì„œìš¸	ì€í‰êµ¬	ê°ˆí˜„2ë™
1112057	ì„œìš¸	ì€í‰êµ¬	êµ¬ì‚°ë™
1112058	ì„œìš¸	ì€í‰êµ¬	ëŒ€ì¡°ë™
1112059	ì„œìš¸	ì€í‰êµ¬	ì‘ì•”1ë™
1112060	ì„œìš¸	ì€í‰êµ¬	ì‘ì•”2ë™
1112065	ì„œìš¸	ì€í‰êµ¬	ì‹ ì‚¬1ë™
1112066	ì„œìš¸	ì€í‰êµ¬	ì‹ ì‚¬2ë™
1112067	ì„œìš¸	ì€í‰êµ¬	ì¦ì‚°ë™
1112068	ì„œìš¸	ì€í‰êµ¬	ìˆ˜ìƒ‰ë™
1112071	ì„œìš¸	ì€í‰êµ¬	ì§„ê´€ë™
1112072	ì„œìš¸	ì€í‰êµ¬	ë¶ˆê´‘2ë™
1112073	ì„œìš¸	ì€í‰êµ¬	ì‘ì•”3ë™
1112074	ì„œìš¸	ì€í‰êµ¬	ì—­ì´Œë™
1113052	ì„œìš¸	ì„œëŒ€ë¬¸êµ¬	ì²œì—°ë™
1113062	ì„œìš¸	ì„œëŒ€ë¬¸êµ¬	í™ì œ1ë™
1113064	ì„œìš¸	ì„œëŒ€ë¬¸êµ¬	í™ì œ3ë™
1113065	ì„œìš¸	ì„œëŒ€ë¬¸êµ¬	í™ì œ2ë™
1113066	ì„œìš¸	ì„œëŒ€ë¬¸êµ¬	í™ì€1ë™
1113068	ì„œìš¸	ì„œëŒ€ë¬¸êµ¬	í™ì€2ë™
1113069	ì„œìš¸	ì„œëŒ€ë¬¸êµ¬	ë‚¨ê°€ì¢Œ1ë™
1113070	ì„œìš¸	ì„œëŒ€ë¬¸êµ¬	ë‚¨ê°€ì¢Œ2ë™
1113071	ì„œìš¸	ì„œëŒ€ë¬¸êµ¬	ë¶ê°€ì¢Œ1ë™
1113072	ì„œìš¸	ì„œëŒ€ë¬¸êµ¬	ë¶ê°€ì¢Œ2ë™
1113073	ì„œìš¸	ì„œëŒ€ë¬¸êµ¬	ì¶©í˜„ë™
1113074	ì„œìš¸	ì„œëŒ€ë¬¸êµ¬	ë¶ì•„í˜„ë™
1113075	ì„œìš¸	ì„œëŒ€ë¬¸êµ¬	ì‹ ì´Œë™
1113076	ì„œìš¸	ì„œëŒ€ë¬¸êµ¬	ì—°í¬ë™
1114059	ì„œìš¸	ë§ˆí¬êµ¬	ìš©ê°•ë™
1114060	ì„œìš¸	ë§ˆí¬êµ¬	ëŒ€í¥ë™
1114061	ì„œìš¸	ë§ˆí¬êµ¬	ì—¼ë¦¬ë™
1114063	ì„œìš¸	ë§ˆí¬êµ¬	ì‹ ìˆ˜ë™
1114066	ì„œìš¸	ë§ˆí¬êµ¬	ì„œêµë™
1114068	ì„œìš¸	ë§ˆí¬êµ¬	í•©ì •ë™
1114069	ì„œìš¸	ë§ˆí¬êµ¬	ë§ì›1ë™
1114070	ì„œìš¸	ë§ˆí¬êµ¬	ë§ì›2ë™
1114071	ì„œìš¸	ë§ˆí¬êµ¬	ì—°ë‚¨ë™
1114072	ì„œìš¸	ë§ˆí¬êµ¬	ì„±ì‚°1ë™
1114073	ì„œìš¸	ë§ˆí¬êµ¬	ì„±ì‚°2ë™
1114074	ì„œìš¸	ë§ˆí¬êµ¬	ìƒì•”ë™
1114075	ì„œìš¸	ë§ˆí¬êµ¬	ë„í™”ë™
1114076	ì„œìš¸	ë§ˆí¬êµ¬	ì„œê°•ë™
1114077	ì„œìš¸	ë§ˆí¬êµ¬	ê³µë•ë™
1114078	ì„œìš¸	ë§ˆí¬êµ¬	ì•„í˜„ë™
1115051	ì„œìš¸	ì–‘ì²œêµ¬	ëª©1ë™
1115052	ì„œìš¸	ì–‘ì²œêµ¬	ëª©2ë™
1115053	ì„œìš¸	ì–‘ì²œêµ¬	ëª©3ë™
1115054	ì„œìš¸	ì–‘ì²œêµ¬	ëª©4ë™
1115057	ì„œìš¸	ì–‘ì²œêµ¬	ì‹ ì›”1ë™
1115058	ì„œìš¸	ì–‘ì²œêµ¬	ì‹ ì›”2ë™
1115059	ì„œìš¸	ì–‘ì²œêµ¬	ì‹ ì›”3ë™
1115060	ì„œìš¸	ì–‘ì²œêµ¬	ì‹ ì›”4ë™
1115061	ì„œìš¸	ì–‘ì²œêµ¬	ì‹ ì›”5ë™
1115062	ì„œìš¸	ì–‘ì²œêµ¬	ì‹ ì›”6ë™
1115063	ì„œìš¸	ì–‘ì²œêµ¬	ì‹ ì›”7ë™
1115064	ì„œìš¸	ì–‘ì²œêµ¬	ì‹ ì •1ë™
1115065	ì„œìš¸	ì–‘ì²œêµ¬	ì‹ ì •2ë™
1115066	ì„œìš¸	ì–‘ì²œêµ¬	ì‹ ì •3ë™
1115069	ì„œìš¸	ì–‘ì²œêµ¬	ì‹ ì •6ë™
1115070	ì„œìš¸	ì–‘ì²œêµ¬	ì‹ ì •7ë™
1115071	ì„œìš¸	ì–‘ì²œêµ¬	ëª©5ë™
1115072	ì„œìš¸	ì–‘ì²œêµ¬	ì‹ ì •4ë™
1116051	ì„œìš¸	ê°•ì„œêµ¬	ì—¼ì°½ë™
1116052	ì„œìš¸	ê°•ì„œêµ¬	ë“±ì´Œ1ë™
1116053	ì„œìš¸	ê°•ì„œêµ¬	ë“±ì´Œ2ë™
1116054	ì„œìš¸	ê°•ì„œêµ¬	ë“±ì´Œ3ë™
1116055	ì„œìš¸	ê°•ì„œêµ¬	í™”ê³¡ë³¸ë™
1116057	ì„œìš¸	ê°•ì„œêµ¬	í™”ê³¡2ë™
1116058	ì„œìš¸	ê°•ì„œêµ¬	í™”ê³¡3ë™
1116059	ì„œìš¸	ê°•ì„œêµ¬	í™”ê³¡4ë™
1116061	ì„œìš¸	ê°•ì„œêµ¬	í™”ê³¡6ë™
1116063	ì„œìš¸	ê°•ì„œêµ¬	í™”ê³¡8ë™
1116064	ì„œìš¸	ê°•ì„œêµ¬	ê°€ì–‘1ë™
1116065	ì„œìš¸	ê°•ì„œêµ¬	ê°€ì–‘2ë™
1116066	ì„œìš¸	ê°•ì„œêµ¬	ê°€ì–‘3ë™
1116067	ì„œìš¸	ê°•ì„œêµ¬	ë°œì‚°1ë™
1116069	ì„œìš¸	ê°•ì„œêµ¬	ê³µí•­ë™
1116070	ì„œìš¸	ê°•ì„œêµ¬	ë°©í™”1ë™
1116071	ì„œìš¸	ê°•ì„œêµ¬	ë°©í™”2ë™
1116072	ì„œìš¸	ê°•ì„œêµ¬	ë°©í™”3ë™
1116073	ì„œìš¸	ê°•ì„œêµ¬	í™”ê³¡1ë™
1116074	ì„œìš¸	ê°•ì„œêµ¬	ìš°ì¥ì‚°ë™
1117051	ì„œìš¸	êµ¬ë¡œêµ¬	ì‹ ë„ë¦¼ë™
1117052	ì„œìš¸	êµ¬ë¡œêµ¬	êµ¬ë¡œ1ë™
1117054	ì„œìš¸	êµ¬ë¡œêµ¬	êµ¬ë¡œ3ë™
1117055	ì„œìš¸	êµ¬ë¡œêµ¬	êµ¬ë¡œ4ë™
1117056	ì„œìš¸	êµ¬ë¡œêµ¬	êµ¬ë¡œ5ë™
1117061	ì„œìš¸	êµ¬ë¡œêµ¬	ê³ ì²™1ë™
1117062	ì„œìš¸	êµ¬ë¡œêµ¬	ê³ ì²™2ë™
1117064	ì„œìš¸	êµ¬ë¡œêµ¬	ê°œë´‰2ë™
1117065	ì„œìš¸	êµ¬ë¡œêµ¬	ê°œë´‰3ë™
1117067	ì„œìš¸	êµ¬ë¡œêµ¬	ì˜¤ë¥˜1ë™
1117068	ì„œìš¸	êµ¬ë¡œêµ¬	ì˜¤ë¥˜2ë™
1117069	ì„œìš¸	êµ¬ë¡œêµ¬	ìˆ˜ê¶ë™
1117070	ì„œìš¸	êµ¬ë¡œêµ¬	ê°€ë¦¬ë´‰ë™
1117071	ì„œìš¸	êµ¬ë¡œêµ¬	êµ¬ë¡œ2ë™
1117072	ì„œìš¸	êµ¬ë¡œêµ¬	ê°œë´‰1ë™
1118051	ì„œìš¸	ê¸ˆì²œêµ¬	ê°€ì‚°ë™
1118052	ì„œìš¸	ê¸ˆì²œêµ¬	ë…ì‚°1ë™
1118053	ì„œìš¸	ê¸ˆì²œêµ¬	ë…ì‚°2ë™
1118054	ì„œìš¸	ê¸ˆì²œêµ¬	ë…ì‚°3ë™
1118055	ì„œìš¸	ê¸ˆì²œêµ¬	ë…ì‚°4ë™
1118057	ì„œìš¸	ê¸ˆì²œêµ¬	ì‹œí¥1ë™
1118058	ì„œìš¸	ê¸ˆì²œêµ¬	ì‹œí¥2ë™
1118059	ì„œìš¸	ê¸ˆì²œêµ¬	ì‹œí¥3ë™
1118060	ì„œìš¸	ê¸ˆì²œêµ¬	ì‹œí¥4ë™
1118061	ì„œìš¸	ê¸ˆì²œêµ¬	ì‹œí¥5ë™
1119054	ì„œìš¸	ì˜ë“±í¬êµ¬	ì—¬ì˜ë™
1119055	ì„œìš¸	ì˜ë“±í¬êµ¬	ë‹¹ì‚°1ë™
1119056	ì„œìš¸	ì˜ë“±í¬êµ¬	ë‹¹ì‚°2ë™
1119061	ì„œìš¸	ì˜ë“±í¬êµ¬	ì–‘í‰1ë™
1119062	ì„œìš¸	ì˜ë“±í¬êµ¬	ì–‘í‰2ë™
1119063	ì„œìš¸	ì˜ë“±í¬êµ¬	ì‹ ê¸¸1ë™
1119065	ì„œìš¸	ì˜ë“±í¬êµ¬	ì‹ ê¸¸3ë™
1119066	ì„œìš¸	ì˜ë“±í¬êµ¬	ì‹ ê¸¸4ë™
1119067	ì„œìš¸	ì˜ë“±í¬êµ¬	ì‹ ê¸¸5ë™
1119068	ì„œìš¸	ì˜ë“±í¬êµ¬	ì‹ ê¸¸6ë™
1119069	ì„œìš¸	ì˜ë“±í¬êµ¬	ì‹ ê¸¸7ë™
1119070	ì„œìš¸	ì˜ë“±í¬êµ¬	ëŒ€ë¦¼1ë™
1119071	ì„œìš¸	ì˜ë“±í¬êµ¬	ëŒ€ë¦¼2ë™
1119072	ì„œìš¸	ì˜ë“±í¬êµ¬	ëŒ€ë¦¼3ë™
1119073	ì„œìš¸	ì˜ë“±í¬êµ¬	ì˜ë“±í¬ë³¸ë™
1119074	ì„œìš¸	ì˜ë“±í¬êµ¬	ì˜ë“±í¬ë™
1119075	ì„œìš¸	ì˜ë“±í¬êµ¬	ë„ë¦¼ë™
1119076	ì„œìš¸	ì˜ë“±í¬êµ¬	ë¬¸ë˜ë™
1120052	ì„œìš¸	ë™ì‘êµ¬	ë…¸ëŸ‰ì§„2ë™
1120053	ì„œìš¸	ë™ì‘êµ¬	ìƒë„1ë™
1120054	ì„œìš¸	ë™ì‘êµ¬	ìƒë„2ë™
1120055	ì„œìš¸	ë™ì‘êµ¬	ìƒë„3ë™
1120056	ì„œìš¸	ë™ì‘êµ¬	ìƒë„4ë™
1120063	ì„œìš¸	ë™ì‘êµ¬	ì‚¬ë‹¹1ë™
1120065	ì„œìš¸	ë™ì‘êµ¬	ì‚¬ë‹¹3ë™
1120066	ì„œìš¸	ë™ì‘êµ¬	ì‚¬ë‹¹4ë™
1120067	ì„œìš¸	ë™ì‘êµ¬	ì‚¬ë‹¹5ë™
1120068	ì„œìš¸	ë™ì‘êµ¬	ëŒ€ë°©ë™
1120069	ì„œìš¸	ë™ì‘êµ¬	ì‹ ëŒ€ë°©1ë™
1120070	ì„œìš¸	ë™ì‘êµ¬	ì‹ ëŒ€ë°©2ë™
1120071	ì„œìš¸	ë™ì‘êµ¬	í‘ì„ë™
1120072	ì„œìš¸	ë™ì‘êµ¬	ë…¸ëŸ‰ì§„1ë™
1120073	ì„œìš¸	ë™ì‘êµ¬	ì‚¬ë‹¹2ë™
1121052	ì„œìš¸	ê´€ì•…êµ¬	ë³´ë¼ë§¤ë™
1121054	ì„œìš¸	ê´€ì•…êµ¬	ì²­ë¦¼ë™
1121057	ì„œìš¸	ê´€ì•…êµ¬	í–‰ìš´ë™
1121058	ì„œìš¸	ê´€ì•…êµ¬	ë‚™ì„±ëŒ€ë™
1121061	ì„œìš¸	ê´€ì•…êµ¬	ì¤‘ì•™ë™
1121062	ì„œìš¸	ê´€ì•…êµ¬	ì¸í—Œë™
1121063	ì„œìš¸	ê´€ì•…êµ¬	ë‚¨í˜„ë™
1121064	ì„œìš¸	ê´€ì•…êµ¬	ì„œì›ë™
1121065	ì„œìš¸	ê´€ì•…êµ¬	ì‹ ì›ë™
1121066	ì„œìš¸	ê´€ì•…êµ¬	ì„œë¦¼ë™
1121068	ì„œìš¸	ê´€ì•…êµ¬	ì‹ ì‚¬ë™
1121069	ì„œìš¸	ê´€ì•…êµ¬	ì‹ ë¦¼ë™
1121071	ì„œìš¸	ê´€ì•…êµ¬	ë‚œí–¥ë™
1121072	ì„œìš¸	ê´€ì•…êµ¬	ì¡°ì›ë™
1121073	ì„œìš¸	ê´€ì•…êµ¬	ëŒ€í•™ë™
1121078	ì„œìš¸	ê´€ì•…êµ¬	ì€ì²œë™
1121079	ì„œìš¸	ê´€ì•…êµ¬	ì„±í˜„ë™
1121080	ì„œìš¸	ê´€ì•…êµ¬	ì²­ë£¡ë™
1121081	ì„œìš¸	ê´€ì•…êµ¬	ë‚œê³¡ë™
1121082	ì„œìš¸	ê´€ì•…êµ¬	ì‚¼ì„±ë™
1121083	ì„œìš¸	ê´€ì•…êµ¬	ë¯¸ì„±ë™
1122051	ì„œìš¸	ì„œì´ˆêµ¬	ì„œì´ˆ1ë™
1122052	ì„œìš¸	ì„œì´ˆêµ¬	ì„œì´ˆ2ë™
1122053	ì„œìš¸	ì„œì´ˆêµ¬	ì„œì´ˆ3ë™
1122054	ì„œìš¸	ì„œì´ˆêµ¬	ì„œì´ˆ4ë™
1122055	ì„œìš¸	ì„œì´ˆêµ¬	ì ì›ë™
1122056	ì„œìš¸	ì„œì´ˆêµ¬	ë°˜í¬ë³¸ë™
1122057	ì„œìš¸	ì„œì´ˆêµ¬	ë°˜í¬1ë™
1122058	ì„œìš¸	ì„œì´ˆêµ¬	ë°˜í¬2ë™
1122059	ì„œìš¸	ì„œì´ˆêµ¬	ë°˜í¬3ë™
1122060	ì„œìš¸	ì„œì´ˆêµ¬	ë°˜í¬4ë™
1122061	ì„œìš¸	ì„œì´ˆêµ¬	ë°©ë°°ë³¸ë™
1122062	ì„œìš¸	ì„œì´ˆêµ¬	ë°©ë°°1ë™
1122063	ì„œìš¸	ì„œì´ˆêµ¬	ë°©ë°°2ë™
1122064	ì„œìš¸	ì„œì´ˆêµ¬	ë°©ë°°3ë™
1122065	ì„œìš¸	ì„œì´ˆêµ¬	ë°©ë°°4ë™
1122066	ì„œìš¸	ì„œì´ˆêµ¬	ì–‘ì¬1ë™
1122067	ì„œìš¸	ì„œì´ˆêµ¬	ì–‘ì¬2ë™
1122068	ì„œìš¸	ì„œì´ˆêµ¬	ë‚´ê³¡ë™
1123051	ì„œìš¸	ê°•ë‚¨êµ¬	ì‹ ì‚¬ë™
1123052	ì„œìš¸	ê°•ë‚¨êµ¬	ë…¼í˜„1ë™
1123053	ì„œìš¸	ê°•ë‚¨êµ¬	ë…¼í˜„2ë™
1123058	ì„œìš¸	ê°•ë‚¨êµ¬	ì‚¼ì„±1ë™
1123059	ì„œìš¸	ê°•ë‚¨êµ¬	ì‚¼ì„±2ë™
1123060	ì„œìš¸	ê°•ë‚¨êµ¬	ëŒ€ì¹˜1ë™
1123063	ì„œìš¸	ê°•ë‚¨êµ¬	ëŒ€ì¹˜4ë™
1123064	ì„œìš¸	ê°•ë‚¨êµ¬	ì—­ì‚¼1ë™
1123065	ì„œìš¸	ê°•ë‚¨êµ¬	ì—­ì‚¼2ë™
1123066	ì„œìš¸	ê°•ë‚¨êµ¬	ë„ê³¡1ë™
1123067	ì„œìš¸	ê°•ë‚¨êµ¬	ë„ê³¡2ë™
1123068	ì„œìš¸	ê°•ë‚¨êµ¬	ê°œí¬1ë™
1123071	ì„œìš¸	ê°•ë‚¨êµ¬	ê°œí¬4ë™
1123072	ì„œìš¸	ê°•ë‚¨êµ¬	ì¼ì›ë³¸ë™
1123073	ì„œìš¸	ê°•ë‚¨êµ¬	ì¼ì›1ë™
1123074	ì„œìš¸	ê°•ë‚¨êµ¬	ì¼ì›2ë™
1123075	ì„œìš¸	ê°•ë‚¨êµ¬	ìˆ˜ì„œë™
1123076	ì„œìš¸	ê°•ë‚¨êµ¬	ì„¸ê³¡ë™
1123077	ì„œìš¸	ê°•ë‚¨êµ¬	ì••êµ¬ì •ë™
1123078	ì„œìš¸	ê°•ë‚¨êµ¬	ì²­ë‹´ë™
1123079	ì„œìš¸	ê°•ë‚¨êµ¬	ëŒ€ì¹˜2ë™
1123080	ì„œìš¸	ê°•ë‚¨êµ¬	ê°œí¬2ë™
1124051	ì„œìš¸	ì†¡íŒŒêµ¬	í’ë‚©1ë™
1124052	ì„œìš¸	ì†¡íŒŒêµ¬	í’ë‚©2ë™
1124053	ì„œìš¸	ì†¡íŒŒêµ¬	ê±°ì—¬1ë™
1124054	ì„œìš¸	ì†¡íŒŒêµ¬	ê±°ì—¬2ë™
1124055	ì„œìš¸	ì†¡íŒŒêµ¬	ë§ˆì²œ1ë™
1124056	ì„œìš¸	ì†¡íŒŒêµ¬	ë§ˆì²œ2ë™
1124057	ì„œìš¸	ì†¡íŒŒêµ¬	ë°©ì´1ë™
1124058	ì„œìš¸	ì†¡íŒŒêµ¬	ë°©ì´2ë™
1124059	ì„œìš¸	ì†¡íŒŒêµ¬	ì˜¤ë¥œë™
1124060	ì„œìš¸	ì†¡íŒŒêµ¬	ì˜¤ê¸ˆë™
1124061	ì„œìš¸	ì†¡íŒŒêµ¬	ì†¡íŒŒ1ë™
1124062	ì„œìš¸	ì†¡íŒŒêµ¬	ì†¡íŒŒ2ë™
1124063	ì„œìš¸	ì†¡íŒŒêµ¬	ì„ì´Œë™
1124064	ì„œìš¸	ì†¡íŒŒêµ¬	ì‚¼ì „ë™
1124065	ì„œìš¸	ì†¡íŒŒêµ¬	ê°€ë½ë³¸ë™
1124066	ì„œìš¸	ì†¡íŒŒêµ¬	ê°€ë½1ë™
1124067	ì„œìš¸	ì†¡íŒŒêµ¬	ê°€ë½2ë™
1124068	ì„œìš¸	ì†¡íŒŒêµ¬	ë¬¸ì •1ë™
1124069	ì„œìš¸	ì†¡íŒŒêµ¬	ë¬¸ì •2ë™
1124071	ì„œìš¸	ì†¡íŒŒêµ¬	ì ì‹¤ë³¸ë™
1124075	ì„œìš¸	ì†¡íŒŒêµ¬	ì ì‹¤4ë™
1124077	ì„œìš¸	ì†¡íŒŒêµ¬	ì ì‹¤6ë™
1124078	ì„œìš¸	ì†¡íŒŒêµ¬	ì ì‹¤7ë™
1124079	ì„œìš¸	ì†¡íŒŒêµ¬	ì ì‹¤2ë™
1124080	ì„œìš¸	ì†¡íŒŒêµ¬	ì ì‹¤3ë™
1124081	ì„œìš¸	ì†¡íŒŒêµ¬	ì¥ì§€ë™
1124082	ì„œìš¸	ì†¡íŒŒêµ¬	ìœ„ë¡€ë™
1125051	ì„œìš¸	ê°•ë™êµ¬	ê°•ì¼ë™
1125052	ì„œìš¸	ê°•ë™êµ¬	ìƒì¼ë™
1125053	ì„œìš¸	ê°•ë™êµ¬	ëª…ì¼1ë™
1125054	ì„œìš¸	ê°•ë™êµ¬	ëª…ì¼2ë™
1125055	ì„œìš¸	ê°•ë™êµ¬	ê³ ë•1ë™
1125056	ì„œìš¸	ê°•ë™êµ¬	ê³ ë•2ë™
1125058	ì„œìš¸	ê°•ë™êµ¬	ì•”ì‚¬2ë™
1125059	ì„œìš¸	ê°•ë™êµ¬	ì•”ì‚¬3ë™
1125061	ì„œìš¸	ê°•ë™êµ¬	ì²œí˜¸1ë™
1125063	ì„œìš¸	ê°•ë™êµ¬	ì²œí˜¸3ë™
1125065	ì„œìš¸	ê°•ë™êµ¬	ì„±ë‚´1ë™
1125066	ì„œìš¸	ê°•ë™êµ¬	ì„±ë‚´2ë™
1125067	ì„œìš¸	ê°•ë™êµ¬	ì„±ë‚´3ë™
1125070	ì„œìš¸	ê°•ë™êµ¬	ë‘”ì´Œ1ë™
1125071	ì„œìš¸	ê°•ë™êµ¬	ë‘”ì´Œ2ë™
1125072	ì„œìš¸	ê°•ë™êµ¬	ì•”ì‚¬1ë™
1125073	ì„œìš¸	ê°•ë™êµ¬	ì²œí˜¸2ë™
1125074	ì„œìš¸	ê°•ë™êµ¬	ê¸¸ë™"""

def load_region_mapping():
    """ì§€ì—­ ë§¤í•‘ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ì—¬ DataFrameìœ¼ë¡œ ë³€í™˜"""
    lines = region_data.strip().split('\n')[1:]  # í—¤ë” ì œì™¸
    data = []
    for line in lines:
        parts = line.split('\t')
        if len(parts) >= 4:
            data.append({
                'ì½”ë“œ': parts[0],
                'ì‹œë„': parts[1],
                'ì‹œêµ°êµ¬': parts[2], 
                'í–‰ì •ë™': parts[3],
                'ì½”ë“œ7ìë¦¬': parts[0][:7]
            })
    return pd.DataFrame(data)

def detect_delimiter(sample_bytes):
    s = sample_bytes[:2048].decode('utf-8', errors='ignore')
    return '\t' if s.count('\t') > s.count(',') else ','

def process_file(content_bytes, filename, selected_codes):
    delim = detect_delimiter(content_bytes)
    df = None
    for enc in ('utf-8', 'utf-8-sig', 'cp949', 'euc-kr'):
        try:
            df = pd.read_csv(
                io.BytesIO(content_bytes),
                encoding=enc,
                delimiter=delim,
                low_memory=False,
                dtype=str
            )
            break
        except:
            continue
    if df is None:
        raise ValueError(f"{filename}: ì¸ì½”ë”© ì‹¤íŒ¨")
    
    df.columns = df.columns.str.strip().str.replace('"','').str.replace('?','')
    required = [
        'ê¸°ì¤€ì¼ID','ì‹œê°„ëŒ€êµ¬ë¶„','ì§‘ê³„êµ¬ì½”ë“œ',
        'ì´ìƒí™œì¸êµ¬ìˆ˜','ì¤‘êµ­ì¸ì²´ë¥˜ì¸êµ¬ìˆ˜','ì¤‘êµ­ì™¸ì™¸êµ­ì¸ì²´ë¥˜ì¸êµ¬ìˆ˜'
    ]
    if not all(c in df.columns for c in required):
        missing = [c for c in required if c not in df.columns]
        raise ValueError(f"{filename}: í•„ìˆ˜ ì»¬ëŸ¼ ëˆ„ë½ - {missing}")
    
    df = df[required].copy()
    df['ì§‘ê³„êµ¬ì½”ë“œ_str'] = df['ì§‘ê³„êµ¬ì½”ë“œ'].astype(str)
    
    # ì„ íƒëœ ì§€ì—­ì˜ 7ìë¦¬ ì½”ë“œë¡œ í•„í„°ë§
    mask = df['ì§‘ê³„êµ¬ì½”ë“œ_str'].str[:7].isin(selected_codes)
    df = df[mask].copy()
    
    if df.empty:
        return pd.DataFrame()
    
    df['DATE'] = pd.to_datetime(df['ê¸°ì¤€ì¼ID'], format='%Y%m%d', errors='coerce')
    df['TIME'] = pd.to_numeric(df['ì‹œê°„ëŒ€êµ¬ë¶„'], errors='coerce')
    wmap = {0:'ì›”ìš”ì¼',1:'í™”ìš”ì¼',2:'ìˆ˜ìš”ì¼',3:'ëª©ìš”ì¼',4:'ê¸ˆìš”ì¼',5:'í† ìš”ì¼',6:'ì¼ìš”ì¼'}
    df['ìš”ì¼'] = df['DATE'].dt.dayofweek.map(wmap)
    df['ì£¼ì¤‘_or_ì£¼ë§'] = np.where(df['DATE'].dt.dayofweek >= 5, 'ì£¼ë§', 'ì£¼ì¤‘')
    df['CODE'] = df['ì§‘ê³„êµ¬ì½”ë“œ_str']
    
    return pd.DataFrame({
        'DATE': df['DATE'].dt.strftime('%Y-%m-%d'),
        'ìš”ì¼': df['ìš”ì¼'],
        'ì£¼ì¤‘_or_ì£¼ë§': df['ì£¼ì¤‘_or_ì£¼ë§'],
        'TIME': df['TIME'],
        'CODE': df['CODE'],
        'ALL': pd.to_numeric(df['ì´ìƒí™œì¸êµ¬ìˆ˜'], errors='coerce'),
        'CHN': pd.to_numeric(df['ì¤‘êµ­ì¸ì²´ë¥˜ì¸êµ¬ìˆ˜'], errors='coerce'),
        'EXP_CHN': pd.to_numeric(df['ì¤‘êµ­ì™¸ì™¸êµ­ì¸ì²´ë¥˜ì¸êµ¬ìˆ˜'], errors='coerce')
    }).dropna(subset=['DATE','TIME','CODE'])

# ì§€ì—­ ë§¤í•‘ ë°ì´í„° ë¡œë“œ
region_df = load_region_mapping()

# ë“œë¡­ë‹¤ìš´ ì§€ì—­ ì„ íƒ UI
st.header("ğŸ“ ì„œìš¸ ì§€ì—­ ì„ íƒ")
st.info(f"ğŸ“Š ì „ì²´ {len(region_df)} ê°œ í–‰ì •ë™ ë°ì´í„° í¬í•¨ (ì„œìš¸ 25ê°œ êµ¬ ì „ì²´)")

# ì‹œêµ°êµ¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
districts = sorted(region_df['ì‹œêµ°êµ¬'].unique())

col1, col2 = st.columns([1, 2])

with col1:
    selected_district = st.selectbox(
        "ğŸ¢ ì‹œêµ°êµ¬ ì„ íƒ",
        ["ì„ íƒí•˜ì„¸ìš”..."] + districts
    )

# ì„ íƒëœ êµ¬ì— í•´ë‹¹í•˜ëŠ” ë™ ëª©ë¡
available_dongs = []
if selected_district != "ì„ íƒí•˜ì„¸ìš”...":
    available_dongs = sorted(region_df[region_df['ì‹œêµ°êµ¬'] == selected_district]['í–‰ì •ë™'].tolist())

with col2:
    if available_dongs:
        selected_dongs = st.multiselect(
            f"ğŸ˜ï¸ {selected_district} í–‰ì •ë™ ì„ íƒ (ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥)",
            available_dongs
        )
    else:
        st.selectbox(
            "ğŸ˜ï¸ í–‰ì •ë™ ì„ íƒ",
            ["ë¨¼ì € ì‹œêµ°êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”..."],
            disabled=True
        )

# ì„ íƒëœ ì§€ì—­ ì²˜ë¦¬
selected_regions = []
selected_codes = []

if selected_district != "ì„ íƒí•˜ì„¸ìš”..." and 'selected_dongs' in locals() and selected_dongs:
    for dong in selected_dongs:
        code_7 = region_df[
            (region_df['ì‹œêµ°êµ¬'] == selected_district) & 
            (region_df['í–‰ì •ë™'] == dong)
        ]['ì½”ë“œ7ìë¦¬'].iloc[0]
        
        selected_regions.append({
            'district': selected_district,
            'dong': dong,
            'code': code_7
        })
        selected_codes.append(code_7)

# ì„ íƒëœ ì§€ì—­ í‘œì‹œ
if selected_regions:
    st.success(f"âœ… ì„ íƒëœ ì§€ì—­: {len(selected_regions)}ê°œ")
    
    # ì„ íƒëœ ì§€ì—­ì„ 4ì»¬ëŸ¼ìœ¼ë¡œ í‘œì‹œ
    cols = st.columns(4)
    for idx, region in enumerate(selected_regions):
        col_idx = idx % 4
        with cols[col_idx]:
            st.write(f"ğŸ“ **{region['district']}** {region['dong']}")
    
    st.markdown("---")
    
    # íŒŒì¼ ì—…ë¡œë“œ
    uploaded = st.file_uploader(
        "ì™¸êµ­ì¸ ìƒí™œì¸êµ¬ CSV íŒŒì¼ ì—…ë¡œë“œ (ì—¬ëŸ¬ ê°œ ê°€ëŠ¥)", 
        type='csv', 
        accept_multiple_files=True
    )

    if uploaded:
        files_dict = {f.name: f.read() for f in uploaded}
        
        st.subheader("ì²« ë²ˆì§¸ íŒŒì¼ 5í–‰ ë¯¸ë¦¬ë³´ê¸°")
        first_name = list(files_dict)[0]
        sample = files_dict[first_name]
        delim = detect_delimiter(sample)
        for enc in ('utf-8','utf-8-sig','cp949','euc-kr'):
            try:
                df0 = pd.read_csv(io.BytesIO(sample), encoding=enc, delimiter=delim, nrows=5)
                df0.columns = df0.columns.str.strip().str.replace('"','').str.replace('?','')
                st.dataframe(df0)
                break
            except:
                continue

        st.markdown("---")
        
        if st.button("ğŸš€ ì„ íƒëœ ì§€ì—­ìœ¼ë¡œ í•„í„°ë§ ì‹¤í–‰"):
            progress = st.progress(0)
            dfs, errors = [], []
            total = len(files_dict)
            
            for i, (fname, content) in enumerate(files_dict.items(), start=1):
                try:
                    dfp = process_file(content, fname, selected_codes)
                    if not dfp.empty:
                        dfs.append(dfp)
                        st.write(f"âœ“ {fname}: {len(dfp):,}í–‰")
                    else:
                        st.write(f"â—‹ {fname}: 0í–‰")
                except Exception as e:
                    errors.append(str(e))
                    st.write(f"âœ— {fname}: {e}")
                progress.progress(i / total)
            
            if dfs:
                merged = pd.concat(dfs, ignore_index=True).drop_duplicates()
                merged['DATE'] = pd.Categorical(merged['DATE'])
                merged = merged.sort_values(['DATE','TIME','CODE']).reset_index(drop=True)
                st.success(f"ğŸ‰ ë³‘í•© ì™„ë£Œ: ì´ {len(merged):,}í–‰")
                
                # í¬í•¨ëœ ì§€ì—­ ì½”ë“œ í‘œì‹œ
                unique_codes = merged['CODE'].str[:7].unique()
                matched_regions = []
                for code in unique_codes:
                    matches = region_df[region_df['ì½”ë“œ7ìë¦¬'] == code]
                    if not matches.empty:
                        matched_regions.append(f"{matches.iloc[0]['ì‹œêµ°êµ¬']} {matches.iloc[0]['í–‰ì •ë™']}")
                
                if matched_regions:
                    st.info(f"ğŸ“Š ìµœì¢… í¬í•¨ëœ ì§€ì—­: {', '.join(matched_regions)}")
                
                bio = BytesIO()
                merged.to_excel(bio, index=False, engine='openpyxl')
                bio.seek(0)
                data = bio.getvalue()
                fn = f"seoul_regions_{datetime.now():%Y%m%d_%H%M%S}.xlsx"
                st.download_button(
                    "ğŸ“¥ ì„ íƒëœ ì§€ì—­ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ",
                    data=data,
                    file_name=fn,
                    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                )
            if errors:
                st.error("âŒ ì˜¤ë¥˜ ë°œìƒ:")
                for e in errors:
                    st.write("-", e)
else:
    st.info("ğŸ’¡ **ì‚¬ìš© ë°©ë²•:**")
    st.write("1. ğŸ¢ **ì‹œêµ°êµ¬ ì„ íƒ**: 25ê°œ êµ¬ ì¤‘ ì›í•˜ëŠ” êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”")
    st.write("2. ğŸ˜ï¸ **í–‰ì •ë™ ì„ íƒ**: í•´ë‹¹ êµ¬ì˜ í–‰ì •ë™ì„ ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤")
    st.write("3. ğŸ“ **íŒŒì¼ ì—…ë¡œë“œ**: CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ë¶„ì„ì„ ì‹¤í–‰í•˜ì„¸ìš”")
    
    # êµ¬ë³„ í–‰ì •ë™ ìˆ˜ ìš”ì•½
    district_summary = region_df.groupby('ì‹œêµ°êµ¬').size().reset_index(name='í–‰ì •ë™ìˆ˜')
    st.subheader("ğŸ“Š êµ¬ë³„ í–‰ì •ë™ í˜„í™©")
    
    cols = st.columns(5)
    for idx, row in district_summary.iterrows():
        col_idx = idx % 5
        with cols[col_idx]:
            st.metric(f"{row['ì‹œêµ°êµ¬']}", f"{row['í–‰ì •ë™ìˆ˜']}ê°œ")
